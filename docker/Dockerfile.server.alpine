##### Alpine-based backend-only image (server + static frontend) with Node 20 LTS and musl zlib 1.3.1
#
# Notes:
# - Uses node:20-alpine for all stages; zlib package on Alpine provides >=1.3.1.
# - Prisma on Alpine requires linux-musl binary target; we set PRISMA_CLI_BINARY_TARGETS.
# - We install build dependencies only during server-build for any native modules, then remove them.
# - Runtime kept minimal: openssl, ca-certificates, libc6-compat (for some glibc-linked modules), zlib (already present but explicitly added).
# - Entry script reused; ensure it is POSIX sh (already in docker-entrypoint-server.sh).

FROM node:20-alpine AS base
WORKDIR /app

# ------------------------------
# Build frontend
# ------------------------------
FROM node:20-alpine AS frontend-build
WORKDIR /app/frontend
RUN apk add --no-cache ca-certificates
RUN corepack enable && corepack prepare yarn@1.22.22 --activate
COPY ./frontend/package.json ./frontend/yarn.lock* ./
RUN yarn install --network-timeout 100000 && yarn cache clean
COPY ./frontend .
RUN yarn build \
    && mkdir -p /tmp/frontend-dist \
    && cp -r dist /tmp/frontend-dist

# ------------------------------
# Install server deps (production) with musl binary target for Prisma
# ------------------------------
FROM node:20-alpine AS server-build
WORKDIR /app/server
ENV PRISMA_CLI_BINARY_TARGETS=linux-musl
RUN apk add --no-cache openssl ca-certificates libc6-compat zlib \
    && apk add --no-cache --virtual .build-deps python3 make g++
RUN corepack enable && corepack prepare yarn@1.22.22 --activate
COPY ./server/package.json ./server/yarn.lock* ./
RUN yarn install --production --network-timeout 100000 && yarn cache clean
COPY ./server .
RUN npx prisma generate --schema=./prisma/schema.prisma
# Remove build deps to reduce final layer size
RUN apk del .build-deps

# ------------------------------
# Runtime image (server only)
# ------------------------------
FROM base AS runtime
# Ensure required runtime libs (openssl for Prisma, zlib 1.3.1, ca certs, libc6-compat for possible glibc-linked binaries)
RUN apk add --no-cache openssl ca-certificates libc6-compat zlib \
    && npm install -g npm@11.6.2 \
    && npm cache clean --force

# App directory
WORKDIR /app/server

# Copy server production deps and source
COPY --from=server-build /app/server/node_modules ./node_modules
COPY --from=server-build /app/server .

# Copy prebuilt frontend into server/public
COPY --from=frontend-build /tmp/frontend-dist/dist ./public

# Security hardening: remove protobufjs CLI (contains vulnerable taffydb) not needed at runtime
RUN rm -rf ./node_modules/onnx-proto/node_modules/protobufjs/cli || true

# Copy docker helper scripts and default env
COPY ./docker/docker-entrypoint-server.sh /usr/local/bin/
COPY ./docker/.env.example /app/server/.env

RUN chmod +x /usr/local/bin/docker-entrypoint-server.sh \
    && chown -R node:node /app

ENV NODE_ENV=production \
    ANYTHING_LLM_RUNTIME=docker \
    DEPLOYMENT_VERSION=1.9.0

HEALTHCHECK --interval=1m --timeout=10s --start-period=1m \
    CMD node -e "fetch('http://localhost:3001/api/ping').then(r=>process.exit(r.status===200?0:1)).catch(()=>process.exit(1))" || exit 1

EXPOSE 3001

USER node

ENTRYPOINT ["/bin/sh", "/usr/local/bin/docker-entrypoint-server.sh"]
